
# Ford项目iOS部分工作交接文档
**Ford项目Github地址： [https://github.com/smartdevicelink](https://github.com/smartdevicelink)**

## [SmartDeviceLink](https://github.com/smartdevicelink/sdl_ios)
- 项目介绍：
简称SDL，一个可以和Ford车机相连接传输视频流等功能的第三方库，由Ford开发并开源在Github上；它将车载信息娱乐系统连接到智能手机应用程序，为消费者创造联系体验。

- 主要功能：

1. 将手机APP显示的内容转化成视频流，投射到车机端
2. 通过一些具体的组件，跟手机APP交互，获取APP内具体信息
3. 投射途径：USB、WiFi


- 关键代码：
###### 在车机端注册APP
```swift
Class ProxyManager {
// ...
    class func setupManagerConfiguration(with lifecycleConfiguration: SDLLifecycleConfiguration) -> SDLConfiguration {
        lifecycleConfiguration.shortAppName = ExampleAppNameShort
        let appIcon = UIImage(named: ExampleAppLogoName)
        lifecycleConfiguration.appIcon = appIcon != nil ? SDLArtwork(image: appIcon!, persistent: true, as: .PNG) : nil
        lifecycleConfiguration.appType = .media
        lifecycleConfiguration.language = .enUs
        lifecycleConfiguration.languagesSupported = [.enUs, .esMx, .frCa]
        lifecycleConfiguration.ttsName = [SDLTTSChunk(text: "S D L", type: .text)]
        print(lifecycleConfiguration.isMedia)
        
        let lockScreenConfiguration = appIcon != nil ? SDLLockScreenConfiguration.enabledConfiguration(withAppIcon: appIcon!, backgroundColor: nil) : SDLLockScreenConfiguration.enabled()
        return SDLConfiguration(lifecycle: lifecycleConfiguration, lockScreen: lockScreenConfiguration, logging: logConfiguration())
    }
// ...
}
```
- 注意事项：
`appType`默认设置为`.default`，支持媒体功能的APP，比如视频流投射，音视频播放，一定要设置`appType`为`.media`。

- 参考APP：（搜狗导航、嘀嗒出行、QQ音乐、同花顺...）
- GitHub地址：
[https://github.com/smartdevicelink/sdl_ios]
(https://github.com/smartdevicelink/sdl_ios)

## [SDL_iOS_USBMuxd](https://github.com/APCVSRepo/sdl_ios_usbmuxd)
- 项目介绍：
可以让手机APP通过USBMuxd协议与车机进行连接的SDL

- Github地址：
[https://github.com/APCVSRepo/sdl_ios_usbmuxd]
(https://github.com/APCVSRepo/sdl_ios_usbmuxd)

- SVN目录：
`.../SDL/SDLSVN/iOS  Jobs/Projects/sdl_ios_usbmuxd-master`

## EncryptedVideo
- 项目介绍：

1. 集成了SDL的视频流功能，把手机端的页面通过视频流传输到车机端，并且在车机端可以发送相应的点击事件让手机端处理。
2. SVN目录下有几个版本的Project，这个工程，我主要做的就是协助Ford的iOS工程师[袁伟](mailto:WYUAN21@ford.com)解决从`WebView`弹出的`AlertView`和从`WebView`播放的视频无法投射到车机端的问题，可以根据文件的创建修改日期来判断这几个文件的更新顺序。
3. MediaType.

- SVN目录：
1. 代码：`.../SDL/SDLSVN/iOS  Jobs/Projects/EncryptedVideo`
2. ipa：`.../SDL/SDLSVN/iOS  Jobs/ipa/EncryptedVideo.ipa`


- [点击在iPhone上安装](https://www.pgyer.com/uXWa)
***打包这个APP的企业证书好像过期了，有可能无法安装***

## SPT3
* 项目介绍：
主要用来测试集成SDL的APP和车机端信息的交互，defaultType。这个项目我们没有源码，只有一个可安装的ipa包，用来测试的。

* 使用WiFi连接车机的步骤：

1. 点击左侧的Menu按钮，会有左侧栏出现;
2. 点击Current App Settings;
3. 选择TCP/IP;
4. 确保手机和车机在同一网段下，并都可以正常访问互联网；
5. 输入车机端的IP地址，Port输入12345；
6. 点击右上角save.

- SVN目录：
`.../SDL/SDLSVN/iOS  Jobs/ipa/SPT3_resigned.ipa`

- [点击在iPhone上安装](https://www.pgyer.com/hZsO)


![WechatIMG40](media/15378428201635/WechatIMG40.jpeg)
![WechatIMG39](media/15378428201635/WechatIMG39.jpeg)

## 日程Demo
- 项目介绍：
主动为Ford提出为项目添加日程功能的proposal，主要功能就是添加日程会议，其思考原型来源于[BMW云端互联](https://itunes.apple.com/cn/app/bmw云端互联/id1120208127?mt=8)。

- 功能简介：
1. 用户可以在手机端添加日程相关的时间和地点，自动计算用户当前地点达到日程地点的时间，并提前十分钟通过手机推送发送给用户。如果手机连接了车机端，那么车机端会提前十分钟语音报告给用户，是否立即前往XXX地。用户选择是，车机端自动打开导航出发前往目的地。
2. 可以添加会议，添加会议相关的地点，会议相关人员的Email地址、手机号码、会议开始的时间，可以在车机端自动将会议内容通过电子邮件或手机短信发送给相关会议人员，并且将会议添加到日程。
3. 自动同步手机系统中的日历，将手机中日历添加的日程自动同步到手机APP。

- 相关工作：
为了实现这个proposal，我先做了一个相关Demo，用swift开发的。目前这个Demo只实现了手机APP端的相关功能，跟车机端的对接（主要是导航功能）以及如何对接需要你来做，如果有实现方面不明白的可以和[曾欢](mailto:huan.zeng1@pactera.com)沟通。

- SVN目录：

1. 代码目录：`.../SDL/SDLSVN/iOS  Jobs/Projects/ScheduleDemo`
2. 文档目录：`.../SDL/SDLSVN/Customer Resource/Documents/添加日程idea.docx`

## Alert添加icon
- 项目介绍：
主动为Ford提出为SDL添加日程功能的proposal，主要功能顾名思义，就是实现给车机端SDL的Alert控件添加一个icon。

- 相关工作：
相关功能我已经完全实现并已上传至Github，但是最近我查看Github的代码时并未发现我的个人贡献，也是比较烦。所以，我把我做的具体更改在这里也顺道说一下，具体可以查看SVN目录下的几个文件。

- SVN目录：

1. 文档目录：`.../SDL/SDLSVN/Customer Resource/Documents/SDL提案：Alert添加Icon`
2. 代码目录：`.../SDL/SDLSVN/iOS  Jobs/Projects/SDL_iOS_lpz_develop`
3. 相关类：`SDLAlert`、`SDLNames`

## 蓝牙电话
- 项目介绍：
同事[李志刚](mailto:li_zhigang-lzg@pactera.com)主动为Ford提出为SDL添加蓝牙通话功能的proposal，主要功能就是在车机端拨号，通过SDL传输到手机端，让iPhone上当前集成了SDL功能的APP拨出这个号码。

- 主要代码：

```objc
//  SDLOnButtonEvent.h
@property (nullable, copy, nonatomic) NSString *dialNumber;
```

```objc
//  SDLOnButtonEvent.m
- (nullable NSMutableString *)dialNumber {
    return [[parameters sdl_objectForName:SDLNameDialNumber] mutableCopy];
}
```

```objc
//  SDLResponseDispatcher.m
- (void)sdl_runHandlerForButton:(SDLRPCNotificationNotification *)notification {
    __kindof SDLRPCNotification *rpcNotification = notification.notification;

    SDLRPCButtonNotificationHandler handler = nil;
    SDLButtonName name = nil;
    SDLButtonEventMode mode = nil;
    NSNumber *customID = nil;
    NSString *dialNumber = @"";

    if ([rpcNotification isMemberOfClass:[SDLOnButtonEvent class]]) {
        name = ((SDLOnButtonPress *)rpcNotification).buttonName;
        mode = ((SDLOnButtonEvent *)rpcNotification).buttonEventMode;
        dialNumber = ((SDLOnButtonEvent *)rpcNotification).dialNumber;
            if (dialNumber.integerValue > 0 && [mode isEqualToString:SDLButtonEventModeButtonDown]) {
                NSURL *teleUrl = [NSURL URLWithString:[NSString stringWithFormat:@"tel:%@", dialNumber]];
                dispatch_async(dispatch_get_main_queue(), ^{
                    [[UIApplication sharedApplication] openURL:teleUrl];
                });
            }
        customID = ((SDLOnButtonEvent *)rpcNotification).customButtonID;
    } else if ([rpcNotification isMemberOfClass:[SDLOnButtonPress class]]) {
        name = ((SDLOnButtonPress *)rpcNotification).buttonName;
        customID = ((SDLOnButtonPress *)rpcNotification).customButtonID;
    }

    if ([name isEqualToEnum:SDLButtonNameCustomButton]) {
        handler = self.customButtonHandlerMap[customID];
    } else {
        handler = self.buttonHandlerMap[name];
    }

    if (handler) {
        if ([rpcNotification isMemberOfClass:[SDLOnButtonEvent class]]) {
            handler(nil, rpcNotification);
        } else if ([rpcNotification isMemberOfClass:[SDLOnButtonPress class]]) {
            handler(rpcNotification, nil);
        }
    }
}   
```

- 实现思路：
1. SDL端新增了一个dialNumber的接口，手机端也要同步跟进（见`SDLOnButtonEvent`类）；
2. 车机端发送消息到手机端，手机端进行解析并拿到手机号，通过`UIApplication`单例拨出。

- 相关工作：

1. 主要和[李志刚](mailto:li_zhigang-lzg@pactera.com)对接需求，目前拨打电话功能只能在APP运行在前台时实现，如果你的能力允许可以尝试研究一下如何从APP后台拨出号码。仿照音乐后台播放的功能。
2. 目前的功能实现代码是在SDL库里面，你最好能做一个单独的APP，嵌入SDL，并在不改动SDL库源码的前提下，完成这个功能。

- SVN目录： 同`Alert添加icon`代码目录。`.../SDL/SDLSVN/iOS  Jobs/Projects/SDL_iOS_lpz_develop`

## OpenAPI调查
- 项目介绍：
客户方的意思大概是让我们为SDL提供接入百度、京东、腾讯、阿里的统一方式，做一个抽象层，来适配接口。

- 相关工作：

1. 这里的接入没有讲具体的某个功能，你需要大概研究一下这几家公司公开的API，然后调查他们是否有接口类似或者相同，如果有的话，做一个统一的接口，根据需求可以随意切换不同的供应商。你可以理解为用适配器模式做一次开发，但是我们的主要工作就是调研，然后将可行性报告发给客户，如果可行还要给出具体相关方案。
2. 我们已经做了一些接口的调查，但是跟客户的要求好像大相径庭，所以任重而道远。如果有哪里不明白可以直接跟客户[Raymond](mailto: WDAI10@ford.com)沟通。

- SVN目录：`.../SDL/SDLSVN/Customer Resource/Documents/百度OpenAPI调查报告0803.docx`

## 个人建议与总结
1. 这个项目主要是发挥个人的主动性，首先你要深入理解SDL的源码，然后根据你对SDL的理解和你的工作经验，为SDL提出好的proposal并助其实现相关功能；
2. 与车机交互的相关功能多和[曾欢](mailto:huan.zeng1@pactera.com)沟通，项目需求和遇到什么困难多和[李颖](ying.li30@pactera.com)交流，蓝牙电话的相关功能就找[李志刚](mailto:li_zhigang-lzg@pactera.com)；
3. 每天下班前记得写日报，写明今天做了什么，明天计划做什么，不要写大模块，要按你实现的功能具体细分，不要少于50字；每周五下班前记得写周报，总结本周的工作。发给[李颖](mailto:ying.li30@pactera.com)；
4. 这份工作交接文档我做了比较详细的说明，每个可以点击的地方除了人名是可以直接发送邮件，其余的都是相关的链接，你可以查看相关文档或者下载相关文件；
5. 如果我做的相关交接工作不够到位的地方可以直接跟我联系：[刘培壮](mailto: peizhuang.liu@pactera.com)，最后预祝你在这个项目里工作顺利，早日晋升！



## 参考文档
1. [SmartDeviceLink - iOS](www.smartdevicelink.com)
2. [https://github.com/smartdevicelink/sdl_ios_guides](https://github.com/smartdevicelink/sdl_ios_guides)
3. SVN目录下 `.../SDL/SDLSVN/iOS  Jobs/Documents`
4. [百度OpenAPI](https://ai.baidu.com/)


